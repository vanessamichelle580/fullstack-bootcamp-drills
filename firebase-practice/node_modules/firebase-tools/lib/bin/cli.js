"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.cli = cli;
const updateNotifierPkg = require("update-notifier-cjs");
const clc = require("colorette");
const marked_terminal_1 = require("marked-terminal");
const marked_1 = require("marked");
marked_1.marked.use((0, marked_terminal_1.markedTerminal)());
const fs = require("node:fs");
const configstore_1 = require("../configstore");
const errorOut_1 = require("../errorOut");
const logger_1 = require("../logger");
const experiments_1 = require("../experiments");
(0, experiments_1.enableExperimentsFromCliEnvVariable)();
const client = require("..");
const fsutils = require("../fsutils");
const utils = require("../utils");
const fetchMOTD_1 = require("../fetchMOTD");
const command_1 = require("../command");
function cli(pkg) {
    const updateNotifier = updateNotifierPkg({ pkg });
    const args = process.argv.slice(2);
    let cmd;
    if (!process.env.DEBUG && args.includes("--debug")) {
        process.env.DEBUG = "true";
    }
    process.env.IS_FIREBASE_CLI = "true";
    const logFilename = (0, logger_1.useFileLogger)();
    logger_1.logger.debug("-".repeat(70));
    logger_1.logger.debug("Command:      ", process.argv.join(" "));
    logger_1.logger.debug("CLI Version:  ", pkg.version);
    logger_1.logger.debug("Platform:     ", process.platform);
    logger_1.logger.debug("Node Version: ", process.version);
    logger_1.logger.debug("Time:         ", new Date().toString());
    if (utils.envOverrides.length) {
        logger_1.logger.debug("Env Overrides:", utils.envOverrides.join(", "));
    }
    logger_1.logger.debug("-".repeat(70));
    logger_1.logger.debug();
    (0, fetchMOTD_1.fetchMOTD)();
    process.on("exit", (code) => {
        code = typeof process.exitCode === "number" ? process.exitCode : code;
        if (!process.env.DEBUG && code < 2 && fsutils.fileExistsSync(logFilename)) {
            fs.unlinkSync(logFilename);
        }
        if (code > 0 && process.stdout.isTTY) {
            const lastError = configstore_1.configstore.get("lastError") || 0;
            const timestamp = Date.now();
            if (lastError > timestamp - 120000) {
                let help;
                if (code === 1 && cmd) {
                    help = "Having trouble? Try " + clc.bold("firebase [command] --help");
                }
                else {
                    help = "Having trouble? Try again or contact support with contents of firebase-debug.log";
                }
                if (cmd) {
                    console.log();
                    console.log(help);
                }
            }
            configstore_1.configstore.set("lastError", timestamp);
        }
        else {
            configstore_1.configstore.delete("lastError");
        }
        try {
            const installMethod = !process.env.FIREPIT_VERSION ? "npm" : "automatic script";
            const updateCommand = !process.env.FIREPIT_VERSION
                ? "npm install -g firebase-tools"
                : "curl -sL https://firebase.tools | upgrade=true bash";
            const updateMessage = `Update available ${clc.gray("{currentVersion}")} â†’ ${clc.green("{latestVersion}")}\n` +
                `To update to the latest version using ${installMethod}, run\n${clc.cyan(updateCommand)}\n` +
                `For other CLI management options, visit the ${(0, marked_1.marked)("[CLI documentation](https://firebase.google.com/docs/cli#update-cli)")}`;
            updateNotifier.notify({ defer: false, isGlobal: true, message: updateMessage });
        }
        catch (err) {
            logger_1.logger.debug("Error when notifying about new CLI updates:");
            if (err instanceof Error) {
                logger_1.logger.debug(err);
            }
            else {
                logger_1.logger.debug(`${err}`);
            }
        }
    });
    process.on("uncaughtException", (err) => {
        (0, errorOut_1.errorOut)(err);
    });
    const commandName = args[0];
    const isHelp = !args.length ||
        commandName === "help" ||
        (args.length === 1 && commandName === "ext") ||
        commandName === "--help";
    const hasHelpFlag = args.includes("--help") || args.includes("-h");
    if (hasHelpFlag) {
        client.getCommand(commandName);
    }
    if (isHelp) {
        const seen = new Set();
        const loadAll = (obj) => {
            if (seen.has(obj))
                return;
            seen.add(obj);
            for (const [key, value] of Object.entries(obj)) {
                if ((0, command_1.isCommandModule)(value)) {
                    value.load();
                }
                else if (typeof value === "object" &&
                    value !== null &&
                    !Array.isArray(value) &&
                    key !== "cli") {
                    loadAll(value);
                }
            }
        };
        loadAll(client);
    }
    if (!args.length) {
        client.cli.help();
    }
    else {
        cmd = client.cli.parse(process.argv);
    }
}
